import serial
import time

class RobotArmController:
    """WLKATA Mirobotì„ ì œì–´í•˜ëŠ” í´ë˜ìŠ¤ (8x8 ì²´ìŠ¤íŒì— ë§ê²Œ ì¡°ì •)"""
    
    def __init__(self, port='/dev/tty.usbserial-110', baudrate=115200, timeout=1):
        """ì‹œë¦¬ì–¼ í¬íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ëŠ” ìƒì„±ì"""
        self.port = port
        self.baudrate = baudrate
        self.timeout = timeout
        self.ser = None  # ì‹œë¦¬ì–¼ ê°ì²´ ì´ˆê¸°í™”
        
        # ì²´ìŠ¤íŒ ê¸°ì¤€ì  (1,1) = (-10, 40, 20)
        self.square_size = 5  # í•œ ì¹¸ í¬ê¸° (mm)
        self.x_min, self.y_min, self.z_ref = -10, 40, 20  # ì²´ìŠ¤íŒ (1,1) ê¸°ì¤€ì 

        # ë¡œë´‡íŒ” ì´ë™ í•œê³„
        self.x_limit = (-120, 160)  # Xì¶• ì œí•œ (Â°)
        self.y_limit = (-40, 100)  # Yì¶• ì œí•œ (Â°)
        self.z_limit = (-100, 60)  # Zì¶• ì œí•œ (Â°)

         # (1,1) ~ (1,8)ê¹Œì§€ì˜ ì²´ìŠ¤ ì¢Œí‘œ
        self.chess_positions = {
            (1, 1): (-50, -5, 50, 0, -55, 0),
            (1, 2): (-40, -10, 55, 0, -50, 0),
            (1, 3): (-28, -15, 60, 0, -40, 0),
            (1, 4): (-15, -12, 60, 0, -40, 0),
            (1, 5): (-3, -10, 60, 0, -40, 0),
            (1, 6): (10, -10, 60, 0, -45, 0),
            (1, 7): (22, -15, 60, 0, -50, 0),
            (1, 8): (30, 0, 48, 0, -50, 0),

            (2, 1): (-42, 10, 35, 0, -45, 0),
            (2, 2): (-34, 10, 37, 0, -45, 0),  # X ì¦ê°€, ZëŠ” ì•½ê°„ ë†’ì´ ìœ ì§€
            (2, 3): (-25, 10, 40, 0, -45, 0),  # X ì¦ê°€, Z ì¦ê°€
            (2, 4): (-15, 10, 40, 0, -45, 0),  # X ì¦ê°€, Z ìœ ì§€
            (2, 5): (-5, 0, 47, 0, -45, 0),   # X ì¦ê°€, Z ìœ ì§€
            (2, 6): (7, 0, 47, 0, -45, 0),    # X ì¦ê°€, Z ìœ ì§€
            (2, 7): (18, 10, 38, 0, -45, 0),   # X ì¦ê°€, Z ê°ì†Œ
            (2, 8): (26, 10, 35, 0, -45, 0),    # ì´ë¯¸ ì£¼ì–´ì§„ ê°’

            (3, 1): (-38, 20, 20, 0, -45, 0),
            (3, 2): (-30, 20, 22, 0, -45, 0),  # X ì¦ê°€, Z ì¦ê°€
            (3, 3): (-22, 20, 24, 0, -45, 0),  # X ì¦ê°€, Z ì¦ê°€
            (3, 4): (-12, 20, 24, 0, -45, 0),  # X ì¦ê°€, Z ìœ ì§€
            (3, 5): (-3, 10, 35, 0, -45, 0),   # X ì¦ê°€, Z ìœ ì§€
            (3, 6): (6, 10, 35, 0, -55, 0),    # X ì¦ê°€, Z ê°ì†Œ
            (3, 7): (13, 15, 30, 0, -50, 0),   # X ì¦ê°€, Z ê°ì†Œ
            (3, 8): (22, 20, 20, 0, -45, 0),

            
            (4, 1): (-34, 25, 10, 0, -45, 0),
            (4, 2): (-28, 25, 12, 0, -45, 0),  # X ì¦ê°€, Z ì¦ê°€
            (4, 3): (-20, 25, 15, 0, -45, 0),  # X ì¦ê°€, Z ì¦ê°€
            (4, 4): (-12, 25, 15, 0, -45, 0),  # X ì¦ê°€, Z ìœ ì§€
            (4, 5): (-5, 25, 15, 0, -45, 0),   # X ì¦ê°€, Z ìœ ì§€
            (4, 6): (4, 30, 10, 0, -45, 0),    # X ì¦ê°€, Z ê°ì†Œ
            (4, 7): (12, 30, 8, 0, -45, 0),    # X ì¦ê°€, Z ê°ì†Œ
            (4, 8): (18, 30, 5, 0, -40, 0),    # ì´ë¯¸ ì£¼ì–´ì§„ ê°’

            (5, 1): (-30, 40, -12, 0, -35, 0),
            (5, 2): (-25, 40, -10, 0, -35, 0),  # X ì¦ê°€, Z ì¦ê°€
            (5, 3): (-18, 40, -8, 0, -35, 0),  # X ì¦ê°€, Z ì¦ê°€
            (5, 4): (-10, 40, -8, 0, -35, 0),  # X ì¦ê°€, Z ìœ ì§€
            (5, 5): (-3, 40, -8, 0, -35, 0),   # X ì¦ê°€, Z ìœ ì§€
            (5, 6): (5, 45, -10, 0, -35, 0),   # X ì¦ê°€, Z ê°ì†Œ
            (5, 7): (10, 45, -12, 0, -40, 0),  # X ì¦ê°€, Z ê°ì†Œ
            (5, 8): (14, 45, -15, 0, -40, 0),

            (6, 1): (-28, 58, -40, 0, -25, 0),
            (6, 2): (-24, 58, -40, 0, -25, 0),  # X ì¦ê°€, Z ìœ ì§€
            (6, 3): (-18, 58, -40, 0, -25, 0),  # X ì¦ê°€, Z ìœ ì§€
            (6, 4): (-10, 58, -40, 0, -25, 0),  # X ì¦ê°€, Z ìœ ì§€
            (6, 5): (-4, 58, -40, 0, -25, 0),   # X ì¦ê°€, Z ìœ ì§€
            (6, 6): (3, 60, -40, 0, -30, 0),    # X ì¦ê°€, Z ìœ ì§€
            (6, 7): (8, 60, -40, 0, -30, 0),    # X ì¦ê°€, Z ìœ ì§€
            (6, 8): (13, 60, -40, 0, -30, 0),    # ì´ë¯¸ ì£¼ì–´ì§„ ê°’

            (7, 1): (-26, 70, -55, 0, -40, 0),
            (7, 2): (-22, 70, -55, 0, -40, 0),  # X ì¦ê°€, Z ìœ ì§€
            (7, 3): (-17, 70, -55, 0, -40, 0),  # X ì¦ê°€, Z ìœ ì§€
            (7, 4): (-10, 70, -55, 0, -40, 0),  # X ì¦ê°€, Z ìœ ì§€
            (7, 5): (-4, 70, -55, 0, -40, 0),   # X ì¦ê°€, Z ìœ ì§€
            (7, 6): (1, 70, -55, 0, -40, 0),    # X ì¦ê°€, Z ìœ ì§€
            (7, 7): (6, 70, -55, 0, -40, 0),    # X ì¦ê°€, Z ìœ ì§€
            (7, 8): (10, 70, -55, 0, -40, 0) 

        }


    def connect(self):
        """ì‹œë¦¬ì–¼ í¬íŠ¸ ì—°ê²°"""
        try:
            self.ser = serial.Serial(self.port, self.baudrate, timeout=self.timeout)
            time.sleep(2)  # í¬íŠ¸ ì•ˆì •í™” ëŒ€ê¸°
            self.ser.flushInput()  # ì´ì „ ë°ì´í„° ì œê±°
            print(f"âœ… {self.port} í¬íŠ¸ì— ì—°ê²°ë¨!")
        except serial.SerialException as e:
            print(f"âš ï¸ ì‹œë¦¬ì–¼ í¬íŠ¸ ì—ëŸ¬: {e}")

    def send_command(self, command):
        """G-code ëª…ë ¹ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ì½ëŠ” í•¨ìˆ˜"""
        if self.ser is None or not self.ser.is_open:
            print("âš ï¸ ì‹œë¦¬ì–¼ í¬íŠ¸ê°€ ì—´ë ¤ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € `connect()`ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.")
            return None

        command_str = command + '\r\n'  # G-code ëì— ì¤„ë°”ê¿ˆ ì¶”ê°€
        print(f"ğŸ“¡ [ì „ì†¡] {command_str.strip()}")
        self.ser.write(command_str.encode())  # ë°”ì´íŠ¸ë¡œ ë³€í™˜ í›„ ì „ì†¡
        time.sleep(0.5)  # ì‘ë‹µ ëŒ€ê¸°

        response = self.ser.readline().decode().strip()
        print(f"ğŸ“¡ [ì‘ë‹µ] {response}")
        return response  # ì‘ë‹µ ë°˜í™˜

    def move_to(self, x=0, y=0, z=0, A=0, B=0, C=0):
        """ë¡œë´‡íŒ”ì„ ì§€ì •ëœ X, Y, Z ìœ„ì¹˜ë¡œ ì´ë™"""
        # ì œí•œ ë²”ìœ„ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ê°’ ì¡°ì •
        x = min(max(self.x_limit[0], x), self.x_limit[1])
        y = min(max(self.y_limit[0], y), self.y_limit[1])
        z = min(max(self.z_limit[0], z), self.z_limit[1])

        self.send_command("G90")  # ì ˆëŒ€ ì¢Œí‘œ ëª¨ë“œ ì„¤ì •
        self.send_command(f"G0 X{x} Y{y} Z{z} A{A} B{B} C{C}")

    def chess_to_xyz(self, row, col):
        """
        (row, col) ì²´ìŠ¤ ì¢Œí‘œë¥¼ ë¡œë´‡íŒ” X, Y, Z ì¢Œí‘œë¡œ ë³€í™˜.
        """
        x = self.x_min + (col - 1) * self.square_size  # X ì¢Œí‘œ ë³€í™˜
        y = self.y_min + (row - 1) * self.square_size  # Y ì¢Œí‘œ ë³€í™˜
        z = self.z_ref - ((row - 1) * self.square_size)  # Z ì¢Œí‘œ ë³€í™˜
        return (x, y, z)

    def gripper(self, g):
        """ë¡œë´‡íŒ” ê·¸ë¦¬í¼ ê°ë„ ì‘ë™ (30~60)"""
        self.send_command(f"M3 S{g}")

    def close(self):
        """ì‹œë¦¬ì–¼ í¬íŠ¸ ë‹«ê¸°"""
        if self.ser and self.ser.is_open:
            self.ser.close()
            print("ğŸ”Œ ì‹œë¦¬ì–¼ í¬íŠ¸ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤.")

    def pump(self,g):
        """íŒí”„ ì‘ë™ 1000, 500, 0"""
        self.send_command(f"m3 s{g}")

    def chess_move(self, start, target):
        """
        ì²´ìŠ¤íŒì—ì„œ ì²´ìŠ¤ë§ì„ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        :param start: (row, col) ë§ì´ ìˆëŠ” ìœ„ì¹˜
        :param target: (row, col) ì´ë™í•  ìœ„ì¹˜
        """
        if start not in self.chess_positions or target not in self.chess_positions:
            print(f"âš ï¸ {start} ë˜ëŠ” {target} ì¢Œí‘œê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ!")
            return

        x1, y1, z1, A1, B1, C1 = self.chess_positions[start]
        x2, y2, z2, A2, B2, C2 = self.chess_positions[target]

        # 1ï¸âƒ£ ì¶œë°œ ìœ„ì¹˜ë¡œ ì´ë™
        self.move_to(x1,-60,z1,A1,-10,C1)
        self.move_to(x1, y1, z1, A1, B1, C1)
        time.sleep(1)

        # 2ï¸âƒ£ ì²´ìŠ¤ë§ ì§‘ê¸°
        self.pump(500)
        time.sleep(2)

        # 3ï¸âƒ£ Y, B ì¶•ì„ ì¡°ì •í•˜ì—¬ ìˆ˜ì§ ìƒìŠ¹ (Y=-50, B=-10)
        self.move_to(x1, -60, z1, A1, -10, C1)
        time.sleep(1)

        # 4ï¸âƒ£ ëª©í‘œ ìœ„ì¹˜ë¡œ ì´ë™
        self.move_to(x2, -60, z2, A2, -10, C2)
        time.sleep(1)

        # 5ï¸âƒ£ ëª©í‘œ ìœ„ì¹˜ì—ì„œ Y, B ì¶•ì„ ì¡°ì •í•˜ì—¬ ìˆ˜ì§ í•˜ê°•
        self.move_to(x2, y2, z2, A2, B2, C2)
        time.sleep(1)

        # 6ï¸âƒ£ ì²´ìŠ¤ë§ ë†“ê¸°
        self.pump(0)
        time.sleep(2)

        self.move_to(x2,-60,z2,A2,-10,C2)

        print(f"â™Ÿï¸ ì²´ìŠ¤ë§ ì´ë™ ì™„ë£Œ: {start} â†’ {target}")



if __name__ == "__main__":
    robot = RobotArmController(port='/dev/tty.usbserial-110', baudrate=115200)
    robot.connect()


    #robot.move_to(-50, -5, 50, 0, -55, 0)
    robot.move_to(22, -15, 60, 0, -50, 0)
    
    #robot.chess_move((1,7),(3,6))

    # 6í–‰ ë¯¸ì„¸ ì¡°ì • í›„ 7í–‰ ë

    robot.close()
